---

- core:
    listen: ["0.0.0.0", 8081]
    url: "https://seecloud.mirantis.com"
    secrets: /etc/rci-secrets.yaml
    jobs-logs: /tmp/rci-logs
    logs-url: "https://seecloud.mirantis.com/rci/logs/"

- service:
    module: rallyci.services.github
    name: gh
    data-path: /tmp/rci-gh
    sessions-path: /tmp/rci-gh/sessions
    urls:
      oauth2: "/rci/oauth2"
      webhook: "/rci/webhook"
      register: "/rci/register"
      settings: "/rci/settings"

- provider:
    name: os
    module: rallyci.providers.openstack
    ssh:
      default_username: ubuntu
      key_name: rci
      private_key_path: /home/eye/.ssh/test
      jumphost:
        hostname: sc
        username: ubuntu
      access_net: "rci-int-net"
    clusters:
      os-image-builder:
        vm:
          image: rci-u1404
          flavor: m1.small
          interfaces:
            - ["static", "rci-int-net"]
      single_ubuntu:
        ubuntu:
          image: "rci-u1404"
          flavor: rci-1vcpu-1024ram
          interfaces:
            - ["static", "rci-int-net"]
      test_cluster:
        master:
          image: "rci-u1404"
          flavor: rci-1vcpu-1024ram
          interfaces:
            - ["static", "rci-int-net"]
            - ["dynamic", "testcluster-int-net"]
        slave1:
          image: "rci-u1404"
          flavor: rci-1vcpu-1024ram
          interfaces:
            - ["dynamic", "testcluster-int-net"]
        slave2:
          image: "rci-u1404"
          flavor: rci-1vcpu-1024ram
          interfaces:
            - ["dynamic", "testcluster-int-net"]

- script:
    name: env
    data: |
      env

- script:
    name: git-checkout
    data: |
      env
      sudo apt-get -y update
      git help -g || sudo apt-get -y install git
      mkdir -p $GITHUB_REPO
      cd $GITHUB_REPO
      cd ..
      git clone git://github.com/$GITHUB_REPO.git || true
      cd ../$GITHUB_REPO
      git checkout $GITHUB_HEAD

- script:
    name: build-os-image
    data: |
      env
      sudo apt-get -y install git rng-tools gnupg unzip qemu
      sudo chgrp sudo /dev/kvm
      sudo rngd -r /dev/urandom
      cat > keygen <<EOF
      Key-Type: RSA
      Key-Length: 2048
      Subkey-Type: RSA
      Subkey-Length: 2048
      Name-Real: RCI
      Name-Comment: no passphrse
      Name-Email: support@mirantis.com
      Expire-Date: 0
      Passphrase: abc
      %commit
      %echo done
      EOF
      gpg --batch --gen-key keygen
      mv .gnupg /tmp/
      wget https://releases.hashicorp.com/packer/0.11.0/packer_0.11.0_linux_amd64.zip
      unzip packer_0.11.0_linux_amd64.zip
      wget http://buildlogs.centos.org/rolling/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso -O /tmp/CentOS-7-x86_64-Minimal-1511.iso
      cd $GITHUB_REPO
      ../../packer build -only qemu centos7.json
      ls -lha /tmp/

- script:
    name: gzip_logs
    data: |
      gzip /var/log/syslog --stdout > /tmp/syslog.txt.gz

- job:
    name: test-job-1
    provider: os
    cluster: test_cluster
    scripts:
      master:
        - env
    post_scripts:
      master:
        - gzip_logs
    publish:
      master:
        - ["/tmp/syslog.gz", "syslog.txt.gz"]

- job:
    name: test-os-image-builder
    provider: os
    cluster: os-image-builder
    scripts:
      vm:
        - git-checkout
        - build-os-image

- matrix:
    name: image-builder
    projects:
      - r-ci/os-image-builder
    jobs-cr:
      - test-os-image-builder

- matrix:
    name: seecloud
    projects:
      - seecloud/automation
      - seecloud/ceagle
      - r-ci/ci-conf
    jobs-cr:
      - test-job-1
    jobs-push:
      - test-job-1
    jobs-branch:
      - test-job-1
